<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <title>Sensor Dashboard</title>

    <!-- TailwindCSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Charts -->
    <script
      type="text/javascript"
      src="https://www.gstatic.com/charts/loader.js"
    ></script>

    <script>
      google.charts.load("current", { packages: ["corechart"] });
      google.charts.setOnLoadCallback(initialize);

      function initialize() {
        fetchAll();
        setInterval(fetchAll, 5000); // update every 5s
      }

      function fetchAll() {
        fetchSensorData();
        fetchExternalWeather();
      }

      function fetchSensorData() {
        fetch("/data")
          .then((response) => response.json())
          .then((data) => drawCharts(data));
      }

      function fetchExternalWeather() {
        fetch("/external-weather")
          .then((response) => response.json())
          .then((data) => {
            document.getElementById("external-weather").innerHTML = `
                        <strong>External Weather:</strong><br>
            üå°Ô∏è ${data.external_temp} ¬∞C<br>
            üí® ${data.external_windspeed} km/h<br>
            üïí ${data.external_time}
                    `;
          });
      }

      function drawCharts(data) {
        let tempData = [["Time", "BMP280 Temp (¬∞C)", "HTU21D Temp (¬∞C)"]];
        let pressureData = [["Time", "Pressure (hPa)"]];
        let humidityData = [["Time", "Humidity (%)"]];

        data.reverse().forEach((row) => {
          tempData.push([row.timestamp, row.bmp280_temp, row.htu21d_temp]);
          pressureData.push([row.timestamp, row.bmp280_pressure]);
          humidityData.push([row.timestamp, row.htu21d_humidity]);
        });

        drawChart(tempData, "temp_chart", "Temperature (¬∞C)");
        drawChart(pressureData, "pressure_chart", "Pressure (hPa)");
        drawChart(humidityData, "humidity_chart", "Humidity (%)");
      }

      function drawChart(dataArray, elementId, vAxisTitle) {
        const data = google.visualization.arrayToDataTable(dataArray);
        const options = {
          curveType: "function",
          legend: { position: "bottom", textStyle: { color: "#d1d5db" } },
          vAxis: {
            title: vAxisTitle,
            textStyle: { color: "#d1d5db" },
            titleTextStyle: { color: "#d1d5db" },
          },
          hAxis: { textStyle: { color: "#d1d5db" } },
          backgroundColor: "#1f2937", // dark background
          titleTextStyle: { color: "#e5e7eb" },

          // Tooltip style
          tooltip: {
            textStyle: { color: "#111827" }, // Tailwind gray-900 (dark text)
            showColorCode: true,
            isHtml: true,
          },
        };
        const chart = new google.visualization.LineChart(
          document.getElementById(elementId)
        );
        chart.draw(data, options);
      }
    </script>
  </head>

  <body class="bg-gray-900 text-gray-100 min-h-screen p-6">
    <div class="max-w-5xl mx-auto space-y-6">
      <!-- Title -->
      <h1 class="text-center text-4xl font-extrabold text-cyan-400">
        üå°Ô∏è Sensor Dashboard
      </h1>

      <!-- External Weather -->
      <div
        id="external-weather"
        class="bg-blue-700 text-white text-center rounded-lg p-4 shadow-md"
      >
        Loading external weather...
      </div>

      <!-- Charts -->
      <div class="grid md:grid-cols-2 gap-6">
        <div class="bg-gray-800 rounded-lg shadow-lg p-4">
          <h4 class="text-xl font-semibold mb-2 text-cyan-300">Temperature</h4>
          <div id="temp_chart" class="w-full h-80"></div>
        </div>

        <div class="bg-gray-800 rounded-lg shadow-lg p-4">
          <h4 class="text-xl font-semibold mb-2 text-cyan-300">Pressure</h4>
          <div id="pressure_chart" class="w-full h-80"></div>
        </div>

        <div class="bg-gray-800 rounded-lg shadow-lg p-4 md:col-span-2">
          <h4 class="text-xl font-semibold mb-2 text-cyan-300">Humidity</h4>
          <div id="humidity_chart" class="w-full h-80"></div>
        </div>
      </div>
    </div>
  </body>
</html>
